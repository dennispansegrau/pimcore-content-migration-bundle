name: CI Pimcore 11 - PHP 8.2

on:
    push:
        branches: [ main, develop ]
        paths:
            - "**"
    pull_request:
        branches: [ main, develop ]

concurrency:
    group: ci-${{ github.ref }}
    cancel-in-progress: true

jobs:
    pimcore11:
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout
                uses: actions/checkout@v4

            -   name: Pull Pimcore image
                run: |
                    set -ex
                    docker pull docker.io/pimcore/pimcore:php8.2-v3

            -   name: Create Pimcore project
                run: |
                    set -ex
                    docker run \
                      --volume=${{ github.workspace }}/:/test/ \
                      --workdir=/test/ \
                      --user=$(id -u):$(id -g) \
                      docker.io/pimcore/pimcore:php8.2-v3 \
                        composer create-project \
                        pimcore/demo \
                        --no-install \
                        sample-project

            -   name: Docker and Database Setup
                run: |
                    set -ex
                    cd sample-project/
                    docker compose -f docker-compose.yaml config
                    
                    docker compose pull --quiet
                    docker compose down -v --remove-orphans
                    docker compose -f docker-compose.yaml up -d
                    
                    docker compose exec -T -- php bash -c '\
                    curl -sfL https://github.com/powerman/dockerize/releases/download/v0.11.5/dockerize-`uname -s`-`uname -m` \
                    | install /dev/stdin /usr/local/bin/dockerize'
                    
                    docker compose exec -T -- php dockerize -wait tcp://db:3306 -timeout 5m

            -   name: Install bundle
                run: |
                    set -ex
                    cd sample-project/
                    docker compose exec -T --workdir /var/www/html php composer require --no-update dennispansegrau/pimcore-content-migration-bundle:0.1.0
                    docker compose exec -T --workdir /var/www/html php composer update --no-scripts --ignore-platform-req=ext-amqp

            -   name: Install Pimcore
                run: |
                    set -ex
                    cd sample-project/

                    docker compose exec -T --workdir /var/www/html \
                        -e PIMCORE_INSTALL_ADMIN_USERNAME=pimcore \
                        -e PIMCORE_INSTALL_ADMIN_PASSWORD=pimcore \
                        -e PIMCORE_INSTALL_MYSQL_USERNAME=pimcore \
                        -e PIMCORE_INSTALL_MYSQL_PASSWORD=pimcore \
                        -e PIMCORE_INSTALL_MYSQL_DATABASE=pimcore \
                        -e PIMCORE_INSTALL_MYSQL_HOST_SOCKET=db \
                        php vendor/bin/pimcore-install -n

                    docker compose exec -T --workdir /var/www/html \
                        -e DATABASE_URL=mysql://pimcore:pimcore@db:3306/pimcore \
                        php bin/console assets:install --symlink --relative

            -   name: PHPStan and CS (vendor bundle)
                run: |
                    set -ex
                    cd sample-project/
                    docker compose exec -T --workdir /var/www/html php \
                        bash -lc 'composer require --dev --no-interaction --prefer-dist phpstan/phpstan friendsofphp/php-cs-fixer && php -d memory_limit=1G vendor/bin/phpstan analyse -c vendor/dennispansegrau/pimcore-content-migration-bundle/phpstan.neon.dist -a /var/www/html/vendor/autoload.php vendor/dennispansegrau/pimcore-content-migration-bundle/src && vendor/bin/php-cs-fixer check --config=vendor/dennispansegrau/pimcore-content-migration-bundle/.php-cs-fixer.php'

            -   name: Compose down
                if: always()
                run: |
                    cd sample-project/
                    docker compose down -v --remove-orphans
