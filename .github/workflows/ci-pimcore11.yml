name: CI Pimcore 11

on:
  push:
    branches: [main]
    paths:
      - "pimcore-content-migration-bundle/**"
      - ".github/workflows/ci-pimcore11.yml"
  pull_request:
    paths:
      - "pimcore-content-migration-bundle/**"
      - ".github/workflows/ci-pimcore11.yml"

jobs:
  pimcore11:
    runs-on: ubuntu-latest
    container:
      image: pimcore/pimcore:php8.2-v3
    services:
      db:
        image: mariadb:10.11
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: pimcore
          MYSQL_USER: pimcore
          MYSQL_PASSWORD: pimcore
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 -proot"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
      redis:
        image: redis:alpine
    env:
      COMPOSER_ALLOW_SUPERUSER: "1"
      COMPOSER_CACHE_DIR: /tmp/composer-cache
      PIMCORE_APP_DIR: /tmp/pimcore-app
      PIMCORE_PROJECT_PACKAGE: pimcore/demo
      PIMCORE_PROJECT_VERSION: "2024.4.*"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Allow git safe directory
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Composer cache
        uses: actions/cache@v4
        with:
          path: /tmp/composer-cache
          key: ${{ runner.os }}-composer-${{ hashFiles('pimcore-content-migration-bundle/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Create Pimcore demo project
        run: |
          COMPOSER_MEMORY_LIMIT=-1 composer create-project --no-interaction --no-scripts \
            "$PIMCORE_PROJECT_PACKAGE:$PIMCORE_PROJECT_VERSION" "$PIMCORE_APP_DIR"

      - name: Install bundle into Pimcore
        run: |
          cd "$PIMCORE_APP_DIR"
          composer config repositories.bundle path "$GITHUB_WORKSPACE/pimcore-content-migration-bundle"
          composer require --no-interaction dennis-pansegrau/pimcore-content-migration-bundle:@dev

      - name: Install assets
        run: |
          cd "$PIMCORE_APP_DIR"
          bin/console assets:install --symlink --relative

      - name: Install Pimcore (with demo data)
        run: |
          cd "$PIMCORE_APP_DIR"
          vendor/bin/pimcore-install \
            --admin-username=admin \
            --admin-password=admin \
            --mysql-username=pimcore \
            --mysql-password=pimcore \
            --mysql-database=pimcore \
            --mysql-host-socket=db \
            --mysql-port=3306 \
            --no-interaction

      - name: Clear cache
        run: |
          cd "$PIMCORE_APP_DIR"
          bin/console cache:clear

      - name: Enable bundle
        run: |
          cd "$PIMCORE_APP_DIR"
          bin/console pimcore:bundle:install PimcoreContentMigrationBundle --no-interaction

      - name: Bundle dependencies
        run: |
          composer --working-dir="$GITHUB_WORKSPACE/pimcore-content-migration-bundle" install --no-interaction --prefer-dist

      - name: PHPStan
        run: |
          composer --working-dir="$GITHUB_WORKSPACE/pimcore-content-migration-bundle" phpstan

      - name: CS
        run: |
          composer --working-dir="$GITHUB_WORKSPACE/pimcore-content-migration-bundle" cs
