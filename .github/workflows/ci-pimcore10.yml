name: CI Pimcore 10

on:
  push:
    branches: [main]
    paths:
      - "pimcore-content-migration-bundle/**"
      - ".github/workflows/ci-pimcore10.yml"
  pull_request:
    paths:
      - "pimcore-content-migration-bundle/**"
      - ".github/workflows/ci-pimcore10.yml"

jobs:
  pimcore10:
    runs-on: ubuntu-latest
    container:
      image: pimcore/pimcore:php8.1-v1
    services:
      db:
        image: mariadb:10.11
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: pimcore
          MYSQL_USER: pimcore
          MYSQL_PASSWORD: pimcore
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 -proot"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
      redis:
        image: redis:alpine
    env:
      COMPOSER_ALLOW_SUPERUSER: "1"
      COMPOSER_CACHE_DIR: /tmp/composer-cache
      PIMCORE_APP_DIR: /tmp/pimcore-app
      PIMCORE_PROJECT_PACKAGE: pimcore/skeleton
      DATABASE_URL: mysql://pimcore:pimcore@db:3306/pimcore
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Allow git safe directory
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Composer cache
        uses: actions/cache@v4
        with:
          path: /tmp/composer-cache
          key: ${{ runner.os }}-composer-${{ hashFiles('pimcore-content-migration-bundle/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Create Pimcore project
        run: |
          COMPOSER_MEMORY_LIMIT=-1 composer create-project --no-interaction --no-scripts --no-install \
            "$PIMCORE_PROJECT_PACKAGE" "$PIMCORE_APP_DIR"

      - name: Set database env
        run: |
          cd "$PIMCORE_APP_DIR"
          printf '%s\n' 'DATABASE_URL=mysql://pimcore:pimcore@db:3306/pimcore' > .env.local
          if grep -q '^DATABASE_URL=' .env; then
            sed -i 's#^DATABASE_URL=.*#DATABASE_URL=mysql://pimcore:pimcore@db:3306/pimcore#' .env
          else
            printf '%s\n' 'DATABASE_URL=mysql://pimcore:pimcore@db:3306/pimcore' >> .env
          fi

      - name: Pin platform version
        run: |
          cd "$PIMCORE_APP_DIR"
          composer config --global audit.block-insecure false
          composer remove --no-interaction --no-update pimcore/admin-ui-classic-bundle || true
          composer remove --no-interaction --no-update pimcore/quill-bundle || true
          composer require --no-interaction --no-update symfony/dotenv:^5.4
          composer require --no-interaction --no-update pimcore/platform-version:2022.0 pimcore/pimcore:^10.6
          composer update --no-interaction --prefer-dist --ignore-platform-req=ext-amqp --no-audit

      - name: Install bundle into Pimcore
        run: |
          cd "$PIMCORE_APP_DIR"
          composer config repositories.bundle path "$GITHUB_WORKSPACE"
          composer require --no-interaction dennis-pansegrau/pimcore-content-migration-bundle:@dev

      - name: Install assets
        run: |
          cd "$PIMCORE_APP_DIR"
          bin/console assets:install --symlink --relative

      - name: Install Pimcore
        run: |
          cd "$PIMCORE_APP_DIR"
          vendor/bin/pimcore-install \
            --admin-username=admin \
            --admin-password=admin \
            --mysql-username=pimcore \
            --mysql-password=pimcore \
            --mysql-database=pimcore \
            --mysql-host=db \
            --mysql-port=3306 \
            --no-interaction

      - name: Force database URL
        run: |
          cd "$PIMCORE_APP_DIR"
          printf '%s\n' 'DATABASE_URL=mysql://pimcore:pimcore@db:3306/pimcore' > .env.local

      - name: Clear cache
        run: |
          cd "$PIMCORE_APP_DIR"
          DATABASE_URL=mysql://pimcore:pimcore@db:3306/pimcore bin/console cache:clear

      - name: Enable bundle
        run: |
          cd "$PIMCORE_APP_DIR"
          bin/console pimcore:bundle:install PimcoreContentMigrationBundle --no-interaction

      - name: Bundle dependencies
        run: |
          composer --working-dir="$GITHUB_WORKSPACE" install --no-interaction --prefer-dist

      - name: PHPStan
        run: |
          composer --working-dir="$GITHUB_WORKSPACE" phpstan

      - name: CS
        run: |
          composer --working-dir="$GITHUB_WORKSPACE" cs
